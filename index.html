<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Simulados de Psicologia | Versão Aprimorada</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Biblioteca de Ícones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fontes do Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- Configuração Base e Fundo --- */
        :root {
            --theme-color-primary: #16a34a; /* Cor padrão (verde) */
            --background-start-light: #f5f7fa;
            --background-end-light: #c3cfe2;
            --background-start-dark: #232526;
            --background-end-dark: #414345;
            --text-light: #f8f9fa;
            --text-dark: #212529;
            --card-bg-light: white;
            --card-bg-dark: #1f2937;
            --border-light: #e9ecef;
            --border-dark: #374151;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-start-light);
            background-image: linear-gradient(135deg, var(--background-start-light) 0%, var(--background-end-light) 100%);
            color: var(--text-dark);
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        .dark body {
            background-color: var(--background-start-dark);
            background-image: linear-gradient(135deg, var(--background-start-dark) 0%, var(--background-end-dark) 100%);
            color: var(--text-light);
        }

        /* --- Animações --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        /* --- Cabeçalho e Seletor de Tema --- */
        .app-header {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-light);
        }
        .dark .app-header {
            background: rgba(29, 39, 51, 0.5);
            border-bottom: 1px solid var(--border-dark);
        }
        #theme-toggle-btn {
            background-color: #e9ecef;
            color: #495057;
        }
        .dark #theme-toggle-btn {
            background-color: #374151;
            color: #e5e7eb;
        }

        /* --- Tela de Seleção --- */
        .selection-card {
            position: relative;
            background-color: var(--card-bg-light);
            border-radius: 1rem;
            border: 1px solid var(--border-light);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .dark .selection-card {
            background-color: var(--card-bg-dark);
            border-color: var(--border-dark);
        }
        .selection-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: var(--theme-color-primary);
        }
        .card-title {
            font-family: 'Lora', serif;
            font-size: 1.25rem;
            font-weight: 700;
        }
        .card-description {
            font-size: 0.9rem;
            line-height: 1.5;
            color: #6c757d;
        }
        .dark .card-description {
            color: #adb5bd;
        }
        .checkmark-icon {
            display: none;
        }
        .selection-card.completed .checkmark-icon {
            display: block;
        }
        .selection-card.completed {
            opacity: 0.85;
        }

        /* --- Container do Simulado --- */
        .main-card {
            background-color: var(--card-bg-light);
            border-radius: 1.25rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-top: 6px solid var(--theme-color-primary);
            transition: all 0.3s ease-in-out;
        }
        .dark .main-card {
            background-color: var(--card-bg-dark);
        }
        #progress-bar {
            background-color: var(--theme-color-primary);
            transition: width 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* --- Questões e Opções --- */
        #question-text {
            font-family: 'Lora', serif;
        }
        .option-btn {
            border: 2px solid var(--border-light);
            transition: all 0.2s ease;
        }
        .dark .option-btn {
            border-color: var(--border-dark);
        }
        .option-btn:not([disabled]):hover {
            border-color: var(--theme-color-primary);
            transform: translateY(-2px);
        }
        .option-btn.selected {
            border-color: var(--theme-color-primary);
            background-color: color-mix(in srgb, var(--theme-color-primary) 15%, transparent);
        }
        .option-btn.correct {
            background-color: #16a34a !important;
            color: white !important;
            border-color: #15803d !important;
        }
        .option-btn.incorrect {
            background-color: #dc2626 !important;
            color: white !important;
            border-color: #b91c1c !important;
        }

        /* --- Feedback e Resultados --- */
        .feedback-card {
            background-color: color-mix(in srgb, var(--border-light) 50%, transparent);
        }
        .dark .feedback-card {
            background-color: #111827;
        }
        #results-circle {
            stroke: var(--theme-color-primary);
            transition: stroke-dasharray 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .action-btn {
            background-color: var(--theme-color-primary);
            transition: all 0.2s ease;
        }
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            filter: brightness(1.1);
        }
        
        /* --- Tela de Revisão --- */
        .review-question-item {
            border-left: 4px solid;
            transition: background-color 0.3s;
        }
        .review-question-item.correct {
            border-color: #16a34a;
            background-color: rgba(22, 163, 74, 0.05);
        }
        .dark .review-question-item.correct {
            background-color: rgba(22, 163, 74, 0.1);
        }
        .review-question-item.incorrect {
            border-color: #dc2626;
            background-color: rgba(220, 38, 38, 0.05);
        }
        .dark .review-question-item.incorrect {
            background-color: rgba(220, 38, 38, 0.1);
        }
        .review-option {
            border: 1px solid var(--border-light);
        }
        .dark .review-option {
            border: 1px solid var(--border-dark);
        }
        .review-option.user-selected {
            background-color: rgba(220, 38, 38, 0.1);
            border-color: #dc2626;
        }
        .review-option.correct-answer {
            background-color: rgba(22, 163, 74, 0.1);
            border-color: #16a34a;
        }

        /* --- Modal de Notificação --- */
        #notification-modal {
            transition: opacity 0.3s ease-in-out;
        }
        #notification-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Cabeçalho Fixo -->
    <header class="app-header sticky top-0 z-50 w-full">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <i data-lucide="brain-circuit" class="w-8 h-8 text-gray-700 dark:text-gray-200"></i>
                    <span class="text-xl font-bold text-gray-800 dark:text-white">Simulados de Psicologia</span>
                </div>
                <button id="theme-toggle-btn" class="p-2 rounded-full">
                    <i data-lucide="sun" class="h-6 w-6 hidden dark:block"></i>
                    <i data-lucide="moon" class="h-6 w-6 block dark:hidden"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Container Principal da Aplicação -->
    <main id="app-container" class="w-full max-w-4xl mx-auto my-8 md:my-12 px-4">
        
        <!-- Tela de Seleção de Tema -->
        <section id="selection-container" class="fade-in">
            <header class="text-center mb-10">
                <h1 class="text-4xl md:text-5xl font-bold text-gray-800 dark:text-white mb-3">Plataforma de Simulados</h1>
                <p class="text-lg text-gray-600 dark:text-gray-300">Escolha um tema, responda 10 questões e aprimore seus conhecimentos.</p>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Cards serão inseridos dinamicamente aqui -->
            </div>
            <div class="text-center mt-10">
                <button id="clear-history-btn" class="text-sm font-semibold text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-500 transition inline-flex items-center gap-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                    Limpar histórico de questões respondidas
                </button>
            </div>
        </section>

        <!-- Tela de Seleção de Modo -->
        <section id="mode-selection-container" class="hidden fade-in">
            <header class="text-center mb-10">
                <h1 id="mode-selection-title" class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-white mb-3"></h1>
                <p class="text-lg text-gray-600 dark:text-gray-300">Como você prefere estudar hoje?</p>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <button data-mode="practice" class="selection-card p-8 text-center">
                    <i data-lucide="swords" class="w-12 h-12 mx-auto mb-4 text-cyan-500"></i>
                    <h2 class="text-2xl font-bold mb-2 text-gray-800 dark:text-white">Modo Prática</h2>
                    <p class="card-description">Receba feedback instantâneo após cada questão. Ideal para aprender e fixar conteúdo.</p>
                </button>
                <button data-mode="exam" class="selection-card p-8 text-center">
                    <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-4 text-amber-500"></i>
                    <h2 class="text-2xl font-bold mb-2 text-gray-800 dark:text-white">Modo Prova</h2>
                    <p class="card-description">Responda todas as questões e veja seu resultado completo apenas no final. Simule um teste real.</p>
                </button>
            </div>
             <div class="text-center mt-12">
                <button id="back-to-theme-selection-btn" class="font-semibold text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition inline-flex items-center gap-2">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    Voltar para Temas
                </button>
            </div>
        </section>

        <!-- Container do Simulado Ativo -->
        <section id="quiz-container" class="main-card hidden">
            <div id="progress-bar-container" class="h-2 bg-gray-200 dark:bg-gray-700 rounded-t-2xl overflow-hidden">
                <div id="progress-bar" class="h-full"></div>
            </div>
            <div class="p-6 md:p-8">
                <header class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-4 mb-6">
                    <div>
                        <h1 id="quiz-title" class="text-2xl font-bold"></h1>
                        <p id="quiz-subtitle" class="text-sm font-medium text-gray-500 dark:text-gray-400"></p>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="question-counter" class="font-semibold text-gray-700 dark:text-gray-300" aria-live="polite"></span>
                        <span class="score-badge inline-flex items-center gap-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-3 py-1 rounded-full text-sm font-semibold">
                            <i data-lucide="star" class="w-4 h-4 text-amber-500"></i>
                            Pontos: <span id="score">0</span>
                        </span>
                    </div>
                </header>

                <div id="question-area" aria-live="assertive">
                    <h2 id="question-text" class="text-xl/relaxed md:text-2xl/loose mb-8 min-h-[100px] text-gray-800 dark:text-gray-50"></h2>
                    <div id="options-container" class="grid grid-cols-1 gap-4"></div>
                </div>

                <div id="feedback-area" class="feedback-card hidden mt-6 p-4 border-l-4" aria-live="polite">
                    <div class="flex items-center gap-3">
                        <div id="feedback-icon"></div>
                        <h3 id="feedback-title" class="text-lg font-bold"></h3>
                    </div>
                    <p id="explanation-text" class="mt-2 text-gray-700 dark:text-gray-300"></p>
                </div>
                
                <footer class="mt-8 flex justify-between items-center">
                    <button id="back-to-menu-btn-quiz" class="font-semibold text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition inline-flex items-center gap-2">
                        <i data-lucide="x" class="w-4 h-4"></i>
                        Sair
                    </button>
                    <button id="next-btn" class="action-btn hidden text-white font-semibold py-3 px-6 rounded-lg shadow-md inline-flex items-center gap-2">
                        <span>Próxima</span>
                        <i data-lucide="arrow-right"></i>
                    </button>
                </footer>

                <div id="results-area" class="hidden text-center py-8">
                    <h2 class="text-3xl font-bold mb-4">Simulado Finalizado!</h2>
                    <div class="relative w-48 h-48 mx-auto my-6">
                        <svg class="w-full h-full" viewBox="0 0 36 36">
                            <path class="stroke-gray-200 dark:stroke-gray-700" stroke-width="3" fill="none" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path id="results-circle" stroke-width="3" fill="none" stroke-linecap="round" transform="rotate(-90 18 18)" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="final-score" class="text-4xl font-bold"></span>
                        </div>
                    </div>
                    <p class="text-lg mt-6 mb-8" id="final-message"></p>
                    <div class="flex flex-col md:flex-row gap-4 justify-center">
                        <button id="review-answers-btn" class="action-btn bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md inline-flex items-center gap-2">
                            <i data-lucide="search"></i>
                            <span>Revisar Respostas</span>
                        </button>
                        <button id="restart-btn" class="action-btn bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md inline-flex items-center gap-2">
                            <i data-lucide="rotate-cw"></i>
                            <span>Tentar Novamente</span>
                        </button>
                        <button id="back-to-menu-btn-results" class="action-btn bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md inline-flex items-center gap-2">
                            <i data-lucide="home"></i>
                            <span>Menu Principal</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tela de Revisão -->
        <section id="review-container" class="main-card hidden p-6 md:p-8">
            <header class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-4 mb-6">
                <h1 class="text-2xl font-bold">Revisão do Simulado</h1>
                <button id="back-to-results-btn" class="action-btn bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md inline-flex items-center gap-2">
                    <i data-lucide="arrow-left"></i>
                    <span>Voltar</span>
                </button>
            </header>
            <div id="review-content" class="space-y-8"></div>
        </section>
    </main>

    <!-- Modal de Notificação -->
    <div id="notification-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md text-center fade-in">
            <div id="modal-icon" class="mx-auto mb-4"></div>
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800 dark:text-white mb-2"></h3>
            <p id="modal-message" class="text-gray-600 dark:text-gray-300 mb-6"></p>
            <button id="modal-close-btn" class="action-btn bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg">Fechar</button>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Variável Global para o Banco de Questões ---
        let allQuizzes = null;

        // --- Mapeamento de Elementos do DOM ---
        const elements = {
            selectionContainer: document.getElementById('selection-container'),
            selectionGrid: document.querySelector('#selection-container .grid'),
            modeSelectionContainer: document.getElementById('mode-selection-container'),
            quizContainer: document.getElementById('quiz-container'),
            reviewContainer: document.getElementById('review-container'),
            themeToggleBtn: document.getElementById('theme-toggle-btn'),
            clearHistoryBtn: document.getElementById('clear-history-btn'),
            backToThemeSelectionBtn: document.getElementById('back-to-theme-selection-btn'),
            backToMenuBtnQuiz: document.getElementById('back-to-menu-btn-quiz'),
            backToMenuBtnResults: document.getElementById('back-to-menu-btn-results'),
            nextBtn: document.getElementById('next-btn'),
            restartBtn: document.getElementById('restart-btn'),
            reviewAnswersBtn: document.getElementById('review-answers-btn'),
            backToResultsBtn: document.getElementById('back-to-results-btn'),
            quizTitle: document.getElementById('quiz-title'),
            quizSubtitle: document.getElementById('quiz-subtitle'),
            questionCounter: document.getElementById('question-counter'),
            score: document.getElementById('score'),
            questionArea: document.getElementById('question-area'),
            questionText: document.getElementById('question-text'),
            optionsContainer: document.getElementById('options-container'),
            progressBar: document.getElementById('progress-bar'),
            feedbackArea: document.getElementById('feedback-area'),
            feedbackTitle: document.getElementById('feedback-title'),
            feedbackIcon: document.getElementById('feedback-icon'),
            explanationText: document.getElementById('explanation-text'),
            resultsArea: document.getElementById('results-area'),
            finalScore: document.getElementById('final-score'),
            finalMessage: document.getElementById('final-message'),
            resultsCircle: document.getElementById('results-circle'),
            reviewContent: document.getElementById('review-content'),
            modeSelectionTitle: document.getElementById('mode-selection-title'),
            notificationModal: document.getElementById('notification-modal'),
            modalIcon: document.getElementById('modal-icon'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
        };

        // --- Estado da Aplicação ---
        let state = {
            currentQuizKey: null,
            currentQuizData: [], 
            currentQuestionIndex: 0,
            score: 0,
            quizMode: 'practice',
            userAnswers: [],
            answeredQuestions: {}, 
        };
        
        // --- Funções de Estado (Salvar/Carregar) ---
        const saveState = () => {
            localStorage.setItem('answeredQuestions', JSON.stringify(state.answeredQuestions));
        };
        const loadState = () => {
            const savedState = localStorage.getItem('answeredQuestions');
            state.answeredQuestions = savedState ? JSON.parse(savedState) : {};
        };

        // --- Funções de Navegação e UI ---
        const showScreen = (screenToShow) => {
            [elements.selectionContainer, elements.modeSelectionContainer, elements.quizContainer, elements.reviewContainer].forEach(screen => {
                screen.classList.add('hidden');
            });
            if (screenToShow) {
                screenToShow.classList.remove('hidden');
                screenToShow.classList.add('fade-in');
            }
        };

        const showModal = (icon, title, message) => {
            elements.modalIcon.innerHTML = icon;
            elements.modalTitle.textContent = title;
            elements.modalMessage.textContent = message;
            elements.notificationModal.classList.remove('hidden');
            lucide.createIcons();
        };

        const hideModal = () => {
            elements.notificationModal.classList.add('hidden');
        };

        const setTheme = (theme) => {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            localStorage.setItem('quizAppTheme', theme);
            lucide.createIcons();
        };

        const applyThemeColor = (color) => {
            document.documentElement.style.setProperty('--theme-color-primary', color);
        };

        const showMenu = () => {
            showScreen(elements.selectionContainer);
            updateSelectionScreen();
            document.documentElement.style.setProperty('--theme-color-primary', '#16a34a');
        };
        
        const createSelectionCards = () => {
            elements.selectionGrid.innerHTML = '';
            for (const key in allQuizzes) {
                const quiz = allQuizzes[key];
                const card = document.createElement('button');
                card.className = 'selection-card p-6 flex items-center gap-5 text-left';
                card.dataset.quiz = key;

                card.innerHTML = `
                    <div class="checkmark-icon absolute top-3 right-3 text-green-500">
                        <i data-lucide="check-circle-2" class="w-7 h-7"></i>
                    </div>
                    <div class="card-icon flex-shrink-0 w-14 h-14 rounded-xl flex items-center justify-center" style="background-color: ${quiz.theme.color}20; color: ${quiz.theme.color};">
                        <i data-lucide="${quiz.theme.icon}" class="w-8 h-8"></i>
                    </div>
                    <div>
                        <h2 class="card-title text-gray-800 dark:text-white">${quiz.title}</h2>
                        <p class="card-description mt-1">Questões sobre ${quiz.title.toLowerCase()}.</p>
                        <p class="progress-text text-xs font-semibold mt-2 text-gray-500 dark:text-gray-400"></p>
                    </div>
                `;
                elements.selectionGrid.appendChild(card);
            }
            lucide.createIcons();
        };
        
        const updateSelectionScreen = () => {
            if (!allQuizzes) return;
            
            document.querySelectorAll('.selection-card').forEach(card => {
                const quizKey = card.dataset.quiz;
                const totalQuestions = allQuizzes[quizKey].data.length;
                const answeredCount = (state.answeredQuestions[quizKey] || []).length;
                
                const progressText = card.querySelector('.progress-text');
                progressText.textContent = `${answeredCount} / ${totalQuestions} respondidas`;

                if (answeredCount === totalQuestions) {
                    card.classList.add('completed');
                } else {
                    card.classList.remove('completed');
                }
            });
            lucide.createIcons();
        };

        // --- Funções do Simulado ---
        const selectQuizTheme = (quizKey) => {
            state.currentQuizKey = quizKey;
            const quiz = allQuizzes[quizKey];
            if (!quiz) return;

            applyThemeColor(quiz.theme.color);
            elements.modeSelectionTitle.textContent = `Tema: ${quiz.title}`;
            showScreen(elements.modeSelectionContainer);
        };

        const startQuiz = (mode) => {
            state.quizMode = mode;
            const quiz = allQuizzes[state.currentQuizKey];
            if (!quiz) return;

            const fullBank = quiz.data;
            const answeredIndexes = state.answeredQuestions[state.currentQuizKey] || [];
            
            const unansweredBank = fullBank
                .map((questionData, index) => ({ questionData, originalIndex: index }))
                .filter(item => !answeredIndexes.includes(item.originalIndex));

            if (unansweredBank.length === 0) {
                showModal(
                    '<i data-lucide="party-popper" class="w-12 h-12 text-green-500"></i>',
                    'Parabéns!',
                    `Você concluiu todas as ${fullBank.length} questões do tema "${quiz.title}". Tente outro tema ou limpe seu histórico para recomeçar.`
                );
                return;
            }

            unansweredBank.sort(() => 0.5 - Math.random());
            state.currentQuizData = unansweredBank.slice(0, 10);

            state.currentQuestionIndex = 0;
            state.score = 0;
            state.userAnswers = [];

            elements.score.textContent = state.score;
            elements.quizTitle.textContent = quiz.title;
            elements.quizSubtitle.textContent = `Modo ${mode === 'practice' ? 'Prática' : 'Prova'}`;

            elements.resultsArea.classList.add('hidden');
            elements.questionArea.style.display = 'block';
            elements.quizContainer.querySelector('header').style.display = 'flex';
            elements.nextBtn.classList.add('hidden');
            elements.feedbackArea.classList.add('hidden');
            
            showScreen(elements.quizContainer);
            showQuestion();
        };

        const updateProgressBar = () => {
            const progress = ((state.currentQuestionIndex) / state.currentQuizData.length) * 100;
            elements.progressBar.style.width = `${progress}%`;
        };

        const showQuestion = () => {
            updateProgressBar();
            elements.feedbackArea.classList.add('hidden');
            elements.optionsContainer.innerHTML = '';
            
            const currentQuestionItem = state.currentQuizData[state.currentQuestionIndex];
            const questionData = currentQuestionItem.questionData;
            
            elements.questionCounter.textContent = `${state.currentQuestionIndex + 1} / ${state.currentQuizData.length}`;
            
            const questionText = questionData.question.replace(/^\d+\.\s*\(.+?\)\s*/, '');
            elements.questionText.innerHTML = questionText;
            
            const options = questionData.options || [];
            options.forEach(option => {
                const button = document.createElement('button');
                button.innerHTML = `<span>${option}</span>`;
                button.className = 'option-btn p-4 rounded-lg text-left dark:bg-gray-700 bg-gray-50 hover:bg-gray-100 dark:hover:bg-gray-600';
                button.addEventListener('click', () => selectAnswer(button, option));
                elements.optionsContainer.appendChild(button);
            });
            
            elements.nextBtn.classList.add('hidden');
            lucide.createIcons();
        };

        const selectAnswer = (selectedBtn, selectedOption) => {
            const questionData = state.currentQuizData[state.currentQuestionIndex].questionData;
            const isCorrect = selectedOption.trim() === questionData.answer.trim();

            state.userAnswers[state.currentQuestionIndex] = selectedOption;

            Array.from(elements.optionsContainer.children).forEach(button => {
                button.disabled = true;
            });

            selectedBtn.classList.add('selected');

            if (state.quizMode === 'practice') {
                if (isCorrect) {
                    state.score++;
                    elements.score.textContent = state.score;
                    selectedBtn.classList.add('correct');
                    showFeedback(true, questionData.explanation);
                } else {
                    selectedBtn.classList.add('incorrect');
                    Array.from(elements.optionsContainer.children).forEach(button => {
                        if (button.textContent.trim() === questionData.answer.trim()) {
                            button.classList.add('correct');
                        }
                    });
                    showFeedback(false, questionData.explanation);
                }
                elements.nextBtn.classList.remove('hidden');
            } else {
                if (isCorrect) {
                  state.score++;
                }
                goToNextQuestion();
            }
        };

        const showFeedback = (isCorrect, explanation) => {
            elements.feedbackTitle.textContent = isCorrect ? "Resposta Correta!" : "Resposta Incorreta!";
            elements.feedbackTitle.className = `text-lg font-bold ${isCorrect ? 'text-green-700 dark:text-green-400' : 'text-red-700 dark:text-red-400'}`;
            elements.feedbackArea.className = `feedback-card mt-6 p-4 border-l-4 fade-in ${isCorrect ? 'border-green-500' : 'border-red-500'}`;
            elements.feedbackIcon.innerHTML = `<i data-lucide="${isCorrect ? 'check-circle' : 'x-circle'}" class="${isCorrect ? 'text-green-600' : 'text-red-600'}"></i>`;
            elements.explanationText.innerHTML = `<strong>Justificativa:</strong> ${explanation || 'Justificativa não disponível.'}`;
            elements.feedbackArea.classList.remove('hidden');
            lucide.createIcons();
        };

        const goToNextQuestion = () => {
            const isLastQuestion = state.currentQuestionIndex >= state.currentQuizData.length - 1;
            if (isLastQuestion) {
                showResults();
            } else {
                state.currentQuestionIndex++;
                showQuestion();
            }
        };

        const showResults = () => {
            const answeredInThisQuiz = state.currentQuizData.map(item => item.originalIndex);
            const currentAnsweredForTheme = state.answeredQuestions[state.currentQuizKey] || [];
            const newAnsweredSet = new Set([...currentAnsweredForTheme, ...answeredInThisQuiz]);
            state.answeredQuestions[state.currentQuizKey] = Array.from(newAnsweredSet);
            saveState();

            elements.questionArea.style.display = 'none';
            elements.feedbackArea.classList.add('hidden');
            elements.nextBtn.classList.add('hidden');
            elements.quizContainer.querySelector('header').style.display = 'none';
            
            elements.score.textContent = state.score;
            const scorePercent = state.currentQuizData.length > 0 ? Math.round((state.score / state.currentQuizData.length) * 100) : 0;
            elements.finalScore.textContent = `${scorePercent}%`;
            elements.resultsCircle.style.strokeDasharray = `${scorePercent}, 100`;

            let message = "";
            if (scorePercent >= 90) message = "Excelente! Desempenho de alto nível.";
            else if (scorePercent >= 70) message = "Muito bem! Um ótimo resultado.";
            else if (scorePercent >= 50) message = "Bom trabalho. Continue estudando as justificativas.";
            else message = "Não desanime. Use a revisão como guia para seus estudos.";
            
            elements.finalMessage.textContent = message;
            elements.resultsArea.classList.remove('hidden');
            elements.resultsArea.classList.add('fade-in');
        };
        
        const showReview = () => {
            elements.reviewContent.innerHTML = '';
            state.currentQuizData.forEach((item, index) => {
                const question = item.questionData;
                const userAnswer = state.userAnswers[index];
                const isCorrect = userAnswer && userAnswer.trim() === question.answer.trim();

                const questionElement = document.createElement('div');
                questionElement.className = `review-question-item p-4 rounded-lg ${isCorrect ? 'correct' : 'incorrect'}`;
                
                let optionsHtml = (question.options || []).map(option => {
                    let classes = 'review-option p-3 mt-2 rounded-md';
                    const isCorrectAnswer = option.trim() === question.answer.trim();
                    const isUserSelected = option.trim() === userAnswer?.trim();

                    if (isCorrectAnswer) classes += ' correct-answer';
                    if (isUserSelected && !isCorrect) classes += ' user-selected';
                    
                    return `<div class="${classes}">${option}</div>`;
                }).join('');

                const questionText = question.question.replace(/^\d+\.\s*\(.+?\)\s*/, '');
                questionElement.innerHTML = `
                    <h3 class="font-bold text-lg">${index + 1}. ${questionText}</h3>
                    <div class="mt-3 space-y-2">${optionsHtml}</div>
                    <div class="mt-4 p-3 bg-gray-100 dark:bg-gray-800 rounded-md">
                        <strong>Justificativa:</strong> ${question.explanation || 'Justificativa não disponível.'}
                    </div>
                `;
                elements.reviewContent.appendChild(questionElement);
            });
            showScreen(elements.reviewContainer);
        };

        // --- Funções de Carregamento e Transformação de Dados ---
        const transformJsonToQuizzes = (jsonData) => {
            const themeMapping = {
                'Código de Ética Profissional': { key: 'etica', icon: 'shield-check', color: '#2563eb' },
                'Psicologia Educacional': { key: 'educacional', icon: 'graduation-cap', color: '#16a34a' },
                'Psicopatologia - Parte I': { key: 'psicopatologia1', icon: 'brain-circuit', color: '#9333ea' },
                'Psicopatologia - Parte II': { key: 'psicopatologia2', icon: 'heart-pulse', color: '#dc2626' }
            };

            const quizzes = {};

            jsonData.bancoDeQuestoes.forEach(themeData => {
                const themeInfo = themeMapping[themeData.tema];
                if (!themeInfo) return;

                const allQuestionsRaw = [
                    ...(themeData.questoesDiretoDoConcurso || []),
                    ...(themeData.questoesDeConcurso || [])
                ];

                const formattedQuestions = allQuestionsRaw.map(q => {
                    let options = [];
                    let answer = '';

                    if (q.tipo === 'CERTO_ERRADO') {
                        options = ['Certo', 'Errado'];
                        if (q.gabarito.toUpperCase().startsWith('C')) {
                            answer = 'Certo';
                        } else {
                            answer = 'Errado';
                        }
                    } else if (q.alternativas) {
                        options = q.alternativas.map(alt => alt.text);
                        const correctAlternative = q.alternativas.find(alt => alt.key === q.gabarito);
                        answer = correctAlternative ? correctAlternative.text : '';
                    }

                    return {
                        question: q.enunciado,
                        options: options,
                        answer: answer,
                        explanation: `Gabarito: ${q.gabarito}. Fonte: ${q.fonte}`
                    };
                });

                if (!quizzes[themeInfo.key]) {
                    quizzes[themeInfo.key] = {
                        title: themeData.tema,
                        theme: {
                            color: themeInfo.color,
                            icon: themeInfo.icon
                        },
                        data: []
                    };
                }
                quizzes[themeInfo.key].data.push(...formattedQuestions);
            });

            return quizzes;
        };

        const loadQuestions = async () => {
            try {
                // CORREÇÃO: Usar './' para garantir que o caminho seja relativo ao diretório atual.
                const response = await fetch('./bancoDeQuestoes.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const jsonData = await response.json();
                allQuizzes = transformJsonToQuizzes(jsonData);
            } catch (error) {
                console.error("Não foi possível carregar o arquivo de questões:", error);
                showModal(
                    '<i data-lucide="alert-triangle" class="w-12 h-12 text-red-500"></i>',
                    'Erro Crítico',
                    'Não foi possível carregar o banco de questões (bancoDeQuestoes.json). Verifique se o arquivo está na mesma pasta que o index.html e se não há erros de sintaxe no JSON.'
                );
            }
        };


        // --- Event Listeners ---
        elements.themeToggleBtn.addEventListener('click', () => {
            const isDark = document.documentElement.classList.contains('dark');
            setTheme(isDark ? 'light' : 'dark');
        });
        
        elements.clearHistoryBtn.addEventListener('click', () => {
            showModal(
                '<i data-lucide="alert-triangle" class="w-12 h-12 text-yellow-500"></i>',
                'Confirmar Ação',
                'Tem certeza de que deseja limpar todo o seu histórico de questões respondidas? Esta ação não pode ser desfeita.'
            );
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'Sim, limpar histórico';
            confirmBtn.className = 'action-btn bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg mt-4';
            confirmBtn.onclick = () => {
                state.answeredQuestions = {};
                saveState();
                updateSelectionScreen();
                hideModal();
            };
            elements.modalMessage.parentElement.appendChild(confirmBtn);
        });

        elements.selectionGrid.addEventListener('click', (e) => {
            const card = e.target.closest('.selection-card');
            if (card && card.dataset.quiz) {
                selectQuizTheme(card.dataset.quiz);
            }
        });
        
        elements.modeSelectionContainer.addEventListener('click', (e) => {
            const card = e.target.closest('.selection-card');
            if (card && card.dataset.mode) {
                startQuiz(card.dataset.mode);
            }
        });
        
        elements.modalCloseBtn.addEventListener('click', () => {
            const confirmBtn = elements.modalMessage.parentElement.querySelector('.action-btn.bg-red-600');
            if (confirmBtn) confirmBtn.remove();
            hideModal();
        });

        elements.backToThemeSelectionBtn.addEventListener('click', () => showMenu());
        elements.backToMenuBtnQuiz.addEventListener('click', () => showMenu());
        elements.backToMenuBtnResults.addEventListener('click', () => showMenu());
        elements.backToResultsBtn.addEventListener('click', () => showScreen(elements.quizContainer));

        elements.nextBtn.addEventListener('click', goToNextQuestion);
        elements.restartBtn.addEventListener('click', () => startQuiz(state.quizMode));
        elements.reviewAnswersBtn.addEventListener('click', showReview);

        // --- Inicialização ---
        const initializeApp = async () => {
            const preferredTheme = localStorage.getItem('quizAppTheme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            setTheme(preferredTheme);
            loadState();
            
            await loadQuestions(); // Carrega e processa o JSON
            
            if(allQuizzes) {
                createSelectionCards();
                showMenu();
            }
        };

        initializeApp();
    });
    </script>
</body>
</html>
